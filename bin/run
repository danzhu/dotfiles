#!/bin/bash

set -e

ERR_FAIL=2
ERR_BUG=3

usage() {
    cat <<EOF
Usage: $0 [OPTION]... FILE [ARGS]

  -h, --help      display this help and exit
  -m, --mem       run with valgrind checking for memory errors
EOF
}

OPTIONS=hm
LONG_OPTIONS=help,mem

if ! OPT=$(getopt --options=$OPTIONS \
                  --longoptions=$LONG_OPTIONS \
                  --name "$0" \
                  -- "$@")
then
    exit $ERR_FAIL
fi

eval set -- "$OPT"

while true; do
    arg="$1"
    shift

    case "$arg" in
        -h|--help)
            usage
            exit
            ;;
        -m|--mem)
            MEM=true
            ;;
        --)
            break
            ;;
        *)
            echo "oops"
            exit $ERR_BUG
            ;;
    esac
done

if [[ $# -lt 1 ]]; then
    usage
    exit $ERR_FAIL
fi

filename="$1"
shift
args=("$@")

execname="${filename%.*}"
execpath="$(readlink -f "$execname")"
cmd=("$execpath")

case "$filename" in
    *.s)
        gcc "$filename" -o "$execpath"
        ;;
    *.c)
        gcc -Wall -Wextra -g "$filename" -o "$execpath"
        ;;
    *.cc|*.cpp|*.C)
        g++ -std=c++17 -Wall -Wextra -g "$filename" -o "$execpath"
        ;;
    *.rs)
        rustc -g "$filename" -o "$execpath"
        ;;
    *.hs)
        stack ghc -- -g "$filename" -o "$execpath"
        ;;
    *.idr)
        idris "$filename" -o "$execpath"
        ;;
    *.java)
        cmd=(java "$execname")
        javac -g "$filename"
        ;;
    *.py)
        cmd=(python "$filename")
        ;;
    *.rb)
        cmd=(ruby "$filename")
        ;;
    *)
        echo "extension not recognized" >&2
        exit $ERR_FAIL
        ;;
esac

if [[ $MEM = true ]]; then
    cmd=(valgrind "--leak-check=full" "${cmd[@]}")
fi

"${cmd[@]}" "${args[@]}"
